<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi EspaÃ±ol - å†°å³¶é¢¨è¥¿ç­ç‰™æ–‡å­¸ç¿’</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #495057;
            --text-light: #6c757d;
            --accent: #a8bcd1;
            --accent-hover: #8ea7c1;
            --border: #e9ecef;
            --shadow: rgba(0,0,0,0.06);
            --soft-green: #b8c5bc;
            --soft-beige: #d9d0c7;
        }
        body.dark {
            --bg: #1e2226;
            --card-bg: #242a30;
            --text: #ced4da;
            --text-light: #adb5bd;
            --accent: #7f9ab3;
            --accent-hover: #94aecd;
            --border: #343a40;
            --shadow: rgba(0,0,0,0.3);
            --soft-green: #8a9a8f;
            --soft-beige: #a89f94;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', -apple-system, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            transition: all 0.4s ease;
        }
        header {
            background: var(--card-bg);
            padding: 1.2rem;
            box-shadow: 0 2px 12px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            margin: 0;
            font-size: 1.7rem;
            text-align: center;
            font-weight: 500;
            letter-spacing: 1px;
            color: var(--accent);
        }
        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }
        button.tab-btn {
            padding: 10px 18px;
            border: none;
            background: transparent;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        button.tab-btn.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent);
            font-weight: 500;
        }
        button.tab-btn:hover {
            color: var(--accent);
        }
        main {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .section {
            display: none;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 6px 20px var(--shadow);
            border: 1px solid var(--border);
        }
        .section.active {
            display: block;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }
        select, input, button {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text);
        }
        button {
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: var(--accent-hover);
        }
        /* é–ƒå¡ - æ›´å°å°ºå¯¸ */
        .flashcard {
            width: 100%;
            max-width: 340px;  /* ç¸®å° */
            height: 240px;
            margin: 30px auto 20px;
            perspective: 1000px;
        }
        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.7s ease;
            border-radius: 16px;
            box-shadow: 0 8px 25px var(--shadow);
        }
        .card-inner.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            border-radius: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
        }
        .back {
            transform: rotateY(180deg);
            background: var(--soft-beige);
        }
        .card-face div:first-child {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 14px;
        }
        .example {
            font-size: 0.9rem;
            opacity: 0.75;
            font-style: italic;
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
        }
        .card-controls {
            text-align: center;
            margin-top: 20px;
        }
        .card-controls button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 1rem;
        }
        .card-controls p {
            margin: 12px 0 0;
            color: var(--text-light);
        }
        .status-btns {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .status-btn {
            padding: 8px 18px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .learning { background: var(--soft-green); }
        .review { background: #e8a87c; }
        .mastered { background: #88a8b3; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--accent);
            color: white;
            font-weight: 500;
        }
        .note-item {
            background: var(--bg);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }
        #darkToggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px var(--shadow);
            z-index: 1000;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .flashcard { 
                max-width: 300px; 
                height: 220px; 
                margin: 20px auto 15px;
            }
            .card-face div:first-child { font-size: 1.5rem; }
            .card-controls button { padding: 8px 16px; margin: 0 8px; }
            .controls { flex-direction: column; align-items: stretch; }
            main { padding: 0 16px; }
            .section { padding: 24px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Mi EspaÃ±ol</h1>
        <nav>
            <button class="tab-btn active" data-tab="flashcards">é–ƒå¡å­¸ç¿’</button>
            <button class="tab-btn" data-tab="review">è¤‡ç¿’æ¸¬é©—</button>
            <button class="tab-btn" data-tab="conjugation">å‹•è©è®ŠåŒ–</button>
            <button class="tab-btn" data-tab="dialogues">å°è©±ç·´ç¿’</button>
            <button class="tab-btn" data-tab="notes">æˆ‘çš„ç­†è¨˜</button>
            <button class="tab-btn" data-tab="importexport">åŒ¯å…¥/åŒ¯å‡º</button>
        </nav>
    </header>

    <main>
        <div id="flashcards" class="section active">
            <div class="controls">
                <select id="categorySelect">
                    <option value="all">å…¨éƒ¨è©å½™</option>
                    <option value="greetings">å•å€™èª</option>
                    <option value="daily">æ—¥å¸¸å°è©±</option>
                    <option value="numbers">æ•¸å­—</option>
                    <option value="colors">é¡è‰²</option>
                    <option value="family">å®¶åº­æˆå“¡</option>
                    <option value="food">é£Ÿç‰©</option>
                    <option value="travel">æ—…è¡Œç”¨èª</option>
                </select>
                <select id="modeSelect">
                    <option value="es-to-zh">è¥¿ç­ç‰™æ–‡ â†’ ä¸­æ–‡</option>
                    <option value="zh-to-es">ä¸­æ–‡ â†’ è¥¿ç­ç‰™æ–‡</option>
                </select>
                <select id="statusFilter">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="learning">é‚„åœ¨å­¸</option>
                    <option value="review">å†è¤‡ç¿’</option>
                    <option value="mastered">å·²æŒæ¡</option>
                </select>
            </div>
            <div class="flashcard" id="flashcard">
                <div class="card-inner">
                    <div class="card-face front" id="cardFront"></div>
                    <div class="card-face back" id="cardBack"></div>
                </div>
            </div>
            <div class="card-controls">
                <button id="prevCard">â† ä¸Šä¸€å¼µ</button>
                <button id="nextCard">ä¸‹ä¸€å¼µ â†’</button>
                <p id="progressText">ç¬¬ 1 / 1 å¼µ</p>
            </div>
            <div class="status-btns">
                <button class="status-btn learning" data-status="learning">é‚„åœ¨å­¸</button>
                <button class="status-btn review" data-status="review">å†è¤‡ç¿’</button>
                <button class="status-btn mastered" data-status="mastered">å·²æŒæ¡</button>
            </div>
        </div>

        <!-- å…¶ä»–é é¢å…§å®¹ä¿æŒä¸è®Š -->
        <div id="review" class="section">
            <h2 style="margin-top:0; color: var(--accent);">å¡«ç©ºè¤‡ç¿’æ¸¬é©—</h2>
            <div id="quizQuestion" style="font-size:1.2rem; margin:30px 0; line-height:1.8;"></div>
            <input type="text" id="quizAnswer" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ" style="width:100%;max-width:500px;">
            <div style="margin:20px 0;">
                <button id="checkAnswer">æª¢æŸ¥ç­”æ¡ˆ</button>
                <button id="nextQuiz" style="margin-left:12px;">ä¸‹ä¸€é¡Œ</button>
            </div>
            <p id="quizFeedback" style="font-size:1.1rem; font-weight:500;"></p>
        </div>

        <div id="conjugation" class="section">
            <h2 style="color: var(--accent);">å‹•è©ç¾åœ¨å¼è®ŠåŒ–æŸ¥è©¢</h2>
            <input type="text" id="verbInput" placeholder="è¼¸å…¥å‹•è©åŸå½¢ï¼ˆå¦‚ hablar, comer, vivirï¼‰" style="width:100%;max-width:400px;">
            <button id="conjugateBtn" style="margin-top:12px;">æŸ¥è©¢è®ŠåŒ–</button>
            <div id="conjugationTable" style="margin-top:20px;"></div>
        </div>

        <div id="dialogues" class="section">
            <h2 style="color: var(--accent);">å°è©±ç·´ç¿’</h2>
            <select id="dialogueSelect" style="margin-bottom:24px; padding:10px;"></select>
            <div id="dialogueContent"></div>
        </div>

        <div id="notes" class="section">
            <h2 style="color: var(--accent);">æˆ‘çš„å­¸ç¿’ç­†è¨˜</h2>
            <textarea id="newNote" placeholder="å¯«ä¸‹ä½ å­¸åˆ°çš„å–®å­—ã€å¥å­ã€æ–‡æ³•æˆ–å¿ƒå¾—..." rows="5" style="width:100%;"></textarea>
            <button id="saveNote" style="margin-top:12px;">å„²å­˜ç­†è¨˜</button>
            <div id="notesList" style="margin-top:24px;"></div>
        </div>

        <div id="importexport" class="section">
            <h2 style="color: var(--accent);">è³‡æ–™åŒ¯å…¥/åŒ¯å‡º</h2>
            <button id="exportData">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ï¼ˆJSONï¼‰</button>
            <br><br>
            <input type="file" id="importFile" accept=".json">
            <button id="importData">åŒ¯å…¥è³‡æ–™</button>
        </div>
    </main>

    <div id="darkToggle">ğŸŒ™</div>

    <script>
        // è©å½™èˆ‡å°è©±è³‡æ–™ï¼ˆèˆ‡ä¹‹å‰å®Œå…¨ç›¸åŒï¼‰
        const initialVocabulary = [
            { es: "Hola", zh: "ä½ å¥½", category: "greetings", example: "Hola, Â¿cÃ³mo estÃ¡s?" },
            { es: "Buenos dÃ­as", zh: "æ—©å®‰", category: "greetings", example: "Buenos dÃ­as, seÃ±or." },
            { es: "Buenas tardes", zh: "åˆå®‰", category: "greetings" },
            { es: "Buenas noches", zh: "æ™šå®‰", category: "greetings" },
            { es: "AdiÃ³s", zh: "å†è¦‹", category: "greetings" },
            { es: "Â¿CÃ³mo estÃ¡s?", zh: "ä½ å¥½å—ï¼Ÿ", category: "greetings" },
            { es: "Bien, gracias", zh: "å¾ˆå¥½ï¼Œè¬è¬", category: "greetings" },
            { es: "Â¿Y tÃº?", zh: "ä½ å‘¢ï¼Ÿ", category: "greetings" },
            { es: "Por favor", zh: "è«‹", category: "daily" },
            { es: "Gracias", zh: "è¬è¬", category: "daily" },
            { es: "De nada", zh: "ä¸å®¢æ°£", category: "daily" },
            { es: "Lo siento", zh: "å°ä¸èµ·", category: "daily" },
            { es: "SÃ­", zh: "æ˜¯", category: "daily" },
            { es: "No", zh: "ä¸", category: "daily" },
            { es: "Me llamo...", zh: "æˆ‘å«...", category: "daily" },
            { es: "Â¿CÃ³mo te llamas?", zh: "ä½ å«ä»€éº¼åå­—ï¼Ÿ", category: "daily" },
            { es: "uno", zh: "ä¸€", category: "numbers" },
            { es: "dos", zh: "äºŒ", category: "numbers" },
            { es: "tres", zh: "ä¸‰", category: "numbers" },
            { es: "cuatro", zh: "å››", category: "numbers" },
            { es: "cinco", zh: "äº”", category: "numbers" },
            { es: "seis", zh: "å…­", category: "numbers" },
            { es: "siete", zh: "ä¸ƒ", category: "numbers" },
            { es: "ocho", zh: "å…«", category: "numbers" },
            { es: "nueve", zh: "ä¹", category: "numbers" },
            { es: "diez", zh: "å", category: "numbers" },
            { es: "rojo", zh: "ç´…è‰²", category: "colors" },
            { es: "azul", zh: "è—è‰²", category: "colors" },
            { es: "verde", zh: "ç¶ è‰²", category: "colors" },
            { es: "amarillo", zh: "é»ƒè‰²", category: "colors" },
            { es: "negro", zh: "é»‘è‰²", category: "colors" },
            { es: "blanco", zh: "ç™½è‰²", category: "colors" },
            { es: "padre", zh: "çˆ¸çˆ¸", category: "family" },
            { es: "madre", zh: "åª½åª½", category: "family" },
            { es: "hermano", zh: "å“¥å“¥/å¼Ÿå¼Ÿ", category: "family" },
            { es: "hermana", zh: "å§å§/å¦¹å¦¹", category: "family" },
            { es: "abuelo", zh: "çˆºçˆº", category: "family" },
            { es: "abuela", zh: "å¥¶å¥¶", category: "family" },
            { es: "agua", zh: "æ°´", category: "food" },
            { es: "pan", zh: "éºµåŒ…", category: "food" },
            { es: "leche", zh: "ç‰›å¥¶", category: "food" },
            { es: "arroz", zh: "ç±³é£¯", category: "food" },
            { es: "carne", zh: "è‚‰", category: "food" },
            { es: "fruta", zh: "æ°´æœ", category: "food" },
            { es: "Â¿DÃ³nde estÃ¡...?", zh: "...åœ¨å“ªè£¡ï¼Ÿ", category: "travel" },
            { es: "el baÃ±o", zh: "å»æ‰€", category: "travel" },
            { es: "la estaciÃ³n", zh: "è»Šç«™", category: "travel" },
            { es: "el hotel", zh: "é£¯åº—", category: "travel" },
            { es: "la playa", zh: "æµ·ç˜", category: "travel" },
            { es: "Â¿CuÃ¡nto cuesta?", zh: "å¤šå°‘éŒ¢ï¼Ÿ", category: "travel" },
        ];

        const dialogues = [
            {
                title: "å’–å•¡å»³é»é¤",
                content: [
                    { es: "Buenos dÃ­as. Â¿QuÃ© desea?", zh: "æ—©å®‰ï¼Œæ‚¨è¦é»ä»€éº¼ï¼Ÿ" },
                    { es: "Un cafÃ© con leche, por favor.", zh: "ä¸€æ¯æ‹¿éµï¼Œè¬è¬ã€‚" },
                    { es: "Â¿Algo mÃ¡s?", zh: "é‚„è¦åˆ¥çš„å—ï¼Ÿ" },
                    { es: "No, gracias. Â¿CuÃ¡nto es?", zh: "ä¸è¦äº†ï¼Œè¬è¬ã€‚å¤šå°‘éŒ¢ï¼Ÿ" },
                    { es: "Son cuatro euros.", zh: "å››æ­å…ƒã€‚" },
                    { es: "AquÃ­ tiene. Gracias.", zh: "çµ¦æ‚¨ï¼Œè¬è¬ã€‚" }
                ]
            },
            {
                title: "è‡ªæˆ‘ä»‹ç´¹",
                content: [
                    { es: "Hola, me llamo Ana.", zh: "ä½ å¥½ï¼Œæˆ‘å«Anaã€‚" },
                    { es: "Encantado, soy Pablo. Â¿De dÃ³nde eres?", zh: "å¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œæˆ‘æ˜¯Pabloã€‚ä½ å¾å“ªè£¡ä¾†ï¼Ÿ" },
                    { es: "Soy de TaiwÃ¡n.", zh: "æˆ‘ä¾†è‡ªå°ç£ã€‚" },
                    { es: "Â¡QuÃ© interesante! Bienvenido.", zh: "çœŸæœ‰è¶£ï¼æ­¡è¿ã€‚" }
                ]
            },
            {
                title: "å•è·¯",
                content: [
                    { es: "PerdÃ³n, Â¿dÃ³nde estÃ¡ la estaciÃ³n de tren?", zh: "ä¸å¥½æ„æ€ï¼Œç«è»Šç«™åœ¨å“ªè£¡ï¼Ÿ" },
                    { es: "Siga recto y gire a la derecha en el semÃ¡foro.", zh: "ç›´èµ°ï¼Œåœ¨ç´…ç¶ ç‡ˆå³è½‰ã€‚" },
                    { es: "Â¿EstÃ¡ lejos?", zh: "å¾ˆé å—ï¼Ÿ" },
                    { es: "No, estÃ¡ a unos diez minutos a pie.", zh: "ä¸é ï¼Œèµ°è·¯ç´„ååˆ†é˜ã€‚" },
                    { es: "Muchas gracias.", zh: "éå¸¸è¬è¬ã€‚" }
                ]
            }
        ];

        let vocabulary = [];
        let notes = [];
        let currentCardIndex = 0;
        let filteredCards = [];
        let currentDialogueIndex = 0;

        function init() {
            const savedVocab = localStorage.getItem('espanolVocabulary');
            const savedNotes = localStorage.getItem('espanolNotes');
            const savedDark = localStorage.getItem('espanolDarkMode');

            vocabulary = savedVocab ? JSON.parse(savedVocab) : initialVocabulary.map(item => ({
                ...item,
                status: 'learning',
                correct: 0,
                attempts: 0
            }));
            notes = savedNotes ? JSON.parse(savedNotes) : [];

            if (savedDark === 'true') {
                document.body.classList.add('dark');
                document.getElementById('darkToggle').textContent = 'â˜€ï¸';
            }

            setupEventListeners();
            switchTab('flashcards');
            renderDialogueSelect();
            renderCurrentDialogue();
            renderNotes();
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.tab-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    switchTab(btn.dataset.tab);
                });
            });

            document.getElementById('darkToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                localStorage.setItem('espanolDarkMode', isDark);
                document.getElementById('darkToggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            });

            const cardInner = document.querySelector('.card-inner');
            cardInner.addEventListener('click', () => cardInner.classList.toggle('flipped'));

            document.getElementById('prevCard').addEventListener('click', prevCard);
            document.getElementById('nextCard').addEventListener('click', nextCard);

            document.getElementById('categorySelect').addEventListener('change', filterCards);
            document.getElementById('modeSelect').addEventListener('change', updateCurrentCard);
            document.getElementById('statusFilter').addEventListener('change', filterCards);

            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (filteredCards.length === 0) return;
                    const card = filteredCards[currentCardIndex];
                    card.status = btn.dataset.status;
                    saveVocabulary();
                    updateProgress();
                    nextCard();
                });
            });

            document.getElementById('conjugateBtn').addEventListener('click', conjugateVerb);
            document.getElementById('checkAnswer').addEventListener('click', checkQuiz);
            document.getElementById('nextQuiz').addEventListener('click', generateQuiz);
            document.getElementById('saveNote').addEventListener('click', saveNote);
            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('importData').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', importData);
            document.getElementById('dialogueSelect').addEventListener('change', (e) => {
                currentDialogueIndex = parseInt(e.target.value);
                renderCurrentDialogue();
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (tab === 'flashcards') filterCards();
            if (tab === 'review') generateQuiz();
        }

        function filterCards() {
            const category = document.getElementById('categorySelect').value;
            const status = document.getElementById('statusFilter').value;

            filteredCards = vocabulary.filter(card => {
                if (category !== 'all' && card.category !== category) return false;
                if (status !== 'all' && card.status !== status) return false;
                return true;
            });

            currentCardIndex = 0;
            updateCurrentCard();
        }

        function updateCurrentCard() {
            if (filteredCards.length === 0) {
                document.getElementById('cardFront').innerHTML = '<p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å–®å­—</p>';
                document.getElementById('cardBack').innerHTML = '';
                document.getElementById('progressText').textContent = '0 / 0';
                return;
            }

            const card = filteredCards[currentCardIndex];
            const mode = document.getElementById('modeSelect').value;
            const front = mode === 'es-to-zh' ? card.es : card.zh;
            const back = mode === 'es-to-zh' ? card.zh : card.es;

            document.getElementById('cardFront').innerHTML = `
                <div>${front}</div>
                ${card.example ? `<div class="example">${card.example}</div>` : ''}
            `;
            document.getElementById('cardBack').innerHTML = `
                <div>${back}</div>
                <div style="font-size:0.8rem;margin-top:20px;">
                    æ­£ç¢ºç‡: ${card.attempts > 0 ? Math.round(card.correct / card.attempts * 100) : 0}%
                </div>
            `;

            document.querySelector('.card-inner').classList.remove('flipped');
            document.getElementById('progressText').textContent = `ç¬¬ ${currentCardIndex + 1} / ${filteredCards.length} å¼µ`;
        }

        function prevCard() {
            if (filteredCards.length === 0) return;
            currentCardIndex = (currentCardIndex - 1 + filteredCards.length) % filteredCards.length;
            updateCurrentCard();
        }

        function nextCard() {
            if (filteredCards.length === 0) return;
            currentCardIndex = (currentCardIndex + 1) % filteredCards.length;
            updateCurrentCard();
        }

        function updateProgress() {
            document.getElementById('progressText').textContent = `ç¬¬ ${currentCardIndex + 1} / ${filteredCards.length} å¼µ`;
        }

        function saveVocabulary() {
            localStorage.setItem('espanolVocabulary', JSON.stringify(vocabulary));
        }

        function conjugateVerb() {
            const verb = document.getElementById('verbInput').value.trim().toLowerCase();
            if (!verb) return;

            let root, ending;
            if (verb.endsWith('ar')) { root = verb.slice(0, -2); ending = 'ar'; }
            else if (verb.endsWith('er')) { root = verb.slice(0, -2); ending = 'er'; }
            else if (verb.endsWith('ir')) { root = verb.slice(0, -2); ending = 'ir'; }
            else {
                document.getElementById('conjugationTable').innerHTML = '<p>è«‹è¼¸å…¥è¦å‰‡å‹•è©åŸå½¢ï¼ˆ-ar, -er, -irï¼‰</p>';
                return;
            }

            const conjugations = ending === 'ar' ? 
                ['o', 'as', 'a', 'amos', 'Ã¡is', 'an'] :
                ['o', 'es', 'e', 'emos', 'Ã©is', 'en'];

            const pronouns = ['yo', 'tÃº', 'Ã©l/ella/usted', 'nosotros', 'vosotros', 'ellos/ellas/ustedes'];

            let table = '<table><tr><th>äººç¨±</th><th>' + verb + ' (ç¾åœ¨å¼)</th></tr>';
            pronouns.forEach((p, i) => {
                table += `<tr><td>${p}</td><td>${root}${conjugations[i]}</td></tr>`;
            });
            table += '</table>';
            document.getElementById('conjugationTable').innerHTML = table;
        }

        function generateQuiz() {
            const reviewCards = vocabulary.filter(c => c.status !== 'mastered');
            if (reviewCards.length === 0) {
                document.getElementById('quizQuestion').textContent = 'å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å–®å­—ï¼Œç»§ç»­å­¸ç¿’æ–°å…§å®¹å§ï½';
                document.getElementById('quizAnswer').style.display = 'none';
                document.getElementById('checkAnswer').style.display = 'none';
                document.getElementById('quizFeedback').textContent = '';
                return;
            }

            const card = reviewCards[Math.floor(Math.random() * reviewCards.length)];
            const isEsToZh = Math.random() > 0.5;
            const question = isEsToZh ? card.es : card.zh;
            const answer = isEsToZh ? card.zh : card.es;

            let sentence = card.example || `è«‹ç¿»è­¯ï¼š${question}`;
            document.getElementById('quizQuestion').innerHTML = 
                `<strong>${sentence}</strong><br><br>è«‹è¼¸å…¥å°æ‡‰çš„${isEsToZh ? 'ä¸­æ–‡' : 'è¥¿ç­ç‰™æ–‡'}ï¼š`;

            window.currentQuiz = { card, expected: answer.toLowerCase() };
            document.getElementById('quizAnswer').value = '';
            document.getElementById('quizAnswer').style.display = 'block';
            document.getElementById('checkAnswer').style.display = 'inline-block';
            document.getElementById('quizFeedback').textContent = '';
        }

        function checkQuiz() {
            const input = document.getElementById('quizAnswer').value.trim().toLowerCase();
            const { card, expected } = window.currentQuiz;
            if (!card) return;

            card.attempts++;
            if (input === expected) {
                card.correct++;
                document.getElementById('quizFeedback').innerHTML = '<span style="color:#88a8b3;">æ­£ç¢ºï¼âœ¨</span>';
                if (card.correct / card.attempts >= 0.8) card.status = 'mastered';
            } else {
                document.getElementById('quizFeedback').innerHTML = 
                    `<span style="color:#e8a87c;">ä¸æ­£ç¢ºï¼Œæ­£ç¢ºç­”æ¡ˆï¼š${expected}</span>`;
                card.status = 'review';
            }
            saveVocabulary();
        }

        function renderDialogueSelect() {
            const select = document.getElementById('dialogueSelect');
            select.innerHTML = dialogues.map((d, i) => 
                `<option value="${i}">${d.title}</option>`
            ).join('');
        }

        function renderCurrentDialogue() {
            const dialogue = dialogues[currentDialogueIndex];
            document.getElementById('dialogueContent').innerHTML = `
                <h3 style="color:var(--accent); margin-bottom:20px;">${dialogue.title}</h3>
                <table>
                    ${dialogue.content.map(line => 
                        `<tr><td><strong>${line.es}</strong></td><td>${line.zh}</td></tr>`
                    ).join('')}
                </table>
            `;
        }

        function saveNote() {
            const content = document.getElementById('newNote').value.trim();
            if (!content) return;
            notes.unshift({ content, date: new Date().toLocaleDateString('zh-TW') });
            localStorage.setItem('espanolNotes', JSON.stringify(notes));
            document.getElementById('newNote').value = '';
            renderNotes();
        }

        function renderNotes() {
            const list = document.getElementById('notesList');
            if (notes.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#aaa;">é‚„æ²’æœ‰ç­†è¨˜ï¼Œé–‹å§‹è¨˜éŒ„å§ï¼</p>';
                return;
            }
            list.innerHTML = notes.map(note => `
                <div class="note-item">
                    <div>${note.content.replace(/\n/g, '<br>')}</div>
                    <small style="color:#aaa;">${note.date}</small>
                </div>
            `).join('');
        }

        function exportData() {
            const data = { vocabulary, notes, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mi-espanol-backup.json';
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.vocabulary) {
                        vocabulary = data.vocabulary;
                        saveVocabulary();
                    }
                    if (data.notes) {
                        notes = data.notes;
                        localStorage.setItem('espanolNotes', JSON.stringify(notes));
                        renderNotes();
                    }
                    alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                    filterCards();
                } catch (err) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
